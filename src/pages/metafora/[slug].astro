---
export const prerender = true

import BaseLayout from '../../layouts/BaseLayout.astro'
import VoteButtons from '../../components/VoteButtons'
import { supabase } from '../../lib/supabase'
import type { MetaphorWithVotes } from '../../lib/types'

// Generate static paths for all published metaphors at build time
export async function getStaticPaths() {
  const { data: metaphors, error } = await supabase
    .from('metaphors_with_votes')
    .select('*')
    .eq('status', 'published')

  if (error) {
    console.error('Error fetching metaphors for static paths:', error)
    return []
  }

  return metaphors.map((metaphor) => ({
    params: { slug: metaphor.slug },
    props: { metaphor }
  }))
}

// Get metaphor from props (passed from getStaticPaths)
const { metaphor } = Astro.props

// JSON-LD structured data for better SEO
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "DefinedTerm",
  "name": metaphor.nazev,
  "description": metaphor.definice,
  "inDefinedTermSet": "https://metafory.cz",
  "termCode": metaphor.slug,
  "inLanguage": "cs",
  "text": metaphor.priklad,
  "interactionStatistic": {
    "@type": "InteractionCounter",
    "interactionType": "https://schema.org/LikeAction",
    "userInteractionCount": metaphor.like_count
  }
}
---

<BaseLayout
  title={`${metaphor.nazev} | Metafory.cz`}
  description={metaphor.definice}
>
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  <div class="max-w-3xl">
    <!-- Back button -->
    <div class="mb-8">
      <a
        href="/"
        class="hover:opacity-70 transition-opacity inline-flex items-center gap-2 text-sm"
        style="color: var(--color-text-secondary);"
      >
        ← Zpět na seznam
      </a>
    </div>

    <!-- Metaphor content -->
    <article class="space-y-6">
      <!-- Title -->
      <h1 class="text-4xl sm:text-5xl font-bold mb-4" style="color: var(--color-heading-blue);">
        {metaphor.nazev}
      </h1>

      <!-- Definition -->
      <p class="text-lg sm:text-xl leading-relaxed" style="color: var(--color-text-primary);">
        {metaphor.definice}
      </p>

      <!-- Example -->
      <p class="text-base sm:text-lg italic leading-relaxed" style="color: var(--color-text-tertiary);">
        <span class="font-medium not-italic" style="color: var(--color-text-primary);">Příklad:</span> „{metaphor.priklad}"
      </p>

      <!-- Source -->
      {metaphor.zdroj && (
        <p class="text-sm sm:text-base" style="color: var(--color-text-secondary);">
          <span class="font-medium">Zdroj:</span> {metaphor.zdroj}
        </p>
      )}

      <!-- Voting buttons -->
      <div class="py-4">
        <VoteButtons
          client:load
          metaphorId={metaphor.id}
          initialLikes={metaphor.like_count}
        />
      </div>

      <!-- Author info -->
      {metaphor.autor_jmeno && (
        <p class="text-sm" style="color: var(--color-text-secondary);">
          přidal(a) <span class="font-semibold">{metaphor.autor_jmeno}</span>
          {metaphor.created_at && (
            <span> dne {new Date(metaphor.created_at).toLocaleDateString('cs-CZ')}</span>
          )}
        </p>
      )}
    </article>
  </div>
</BaseLayout>
