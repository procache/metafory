---
export const prerender = false

import BaseLayout from '../../layouts/BaseLayout.astro'
import VoteButtons from '../../components/VoteButtons'
import { supabase } from '../../lib/supabase'
import type { MetaphorWithVotes } from '../../lib/types'

// Get slug from URL params
const { slug } = Astro.params

// Fetch metaphor dynamically based on slug
const { data: metaphor, error } = await supabase
  .from('metaphors_with_votes')
  .select('*')
  .eq('slug', slug)
  .eq('status', 'published')
  .single<MetaphorWithVotes>()

// Return 404 if metaphor not found
if (error || !metaphor) {
  return Astro.redirect('/404')
}

// JSON-LD structured data for better SEO
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "DefinedTerm",
  "name": metaphor.nazev,
  "description": metaphor.definice,
  "inDefinedTermSet": "https://metafory.cz",
  "termCode": metaphor.slug,
  "inLanguage": "cs",
  "text": metaphor.priklad,
  "interactionStatistic": [
    {
      "@type": "InteractionCounter",
      "interactionType": "https://schema.org/LikeAction",
      "userInteractionCount": metaphor.like_count
    },
    {
      "@type": "InteractionCounter",
      "interactionType": "https://schema.org/DislikeAction",
      "userInteractionCount": metaphor.dislike_count
    }
  ]
}
---

<BaseLayout
  title={`${metaphor.nazev} | Metafory.cz`}
  description={metaphor.definice}
>
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  <div>
    <!-- Back button -->
    <div class="mb-10">
      <a
        href="/"
        class="hover:opacity-70 transition-opacity inline-flex items-center gap-2 text-sm font-medium"
        style="color: var(--color-text-secondary);"
      >
        ← Zpět na seznam
      </a>
    </div>

    <!-- Metaphor content -->
    <article class="rounded-xl p-8 sm:p-10" style="background-color: var(--color-bg-card); border: 1.5px solid var(--color-border);">
      <h1 class="text-3xl sm:text-4xl font-bold mb-10 pb-8 tracking-tight leading-tight" style="border-bottom: 1.5px solid var(--color-border); color: var(--color-text-primary);">
        {metaphor.nazev}
      </h1>

      <div class="space-y-10">
        <!-- Definition -->
        <div>
          <h2 class="text-xs font-bold uppercase tracking-wider mb-4" style="color: var(--color-accent-primary);">
            Definice
          </h2>
          <p class="text-lg sm:text-xl leading-relaxed" style="color: var(--color-text-secondary);">
            {metaphor.definice}
          </p>
        </div>

        <!-- Example -->
        <div>
          <h2 class="text-xs font-bold uppercase tracking-wider mb-4" style="color: var(--color-accent-primary);">
            Příklad použití
          </h2>
          <p class="text-base sm:text-lg italic leading-relaxed" style="color: var(--color-text-secondary);">
            „{metaphor.priklad}"
          </p>
        </div>

        <!-- Source -->
        {metaphor.zdroj && (
          <div>
            <h2 class="text-xs font-bold uppercase tracking-wider mb-4" style="color: var(--color-accent-primary);">
              Zdroj
            </h2>
            <p class="text-sm sm:text-base" style="color: var(--color-text-tertiary);">
              {metaphor.zdroj}
            </p>
          </div>
        )}

        <!-- Voting buttons -->
        <div class="pt-8" style="border-top: 1.5px solid var(--color-border);">
          <h2 class="text-xs font-bold uppercase tracking-wider mb-5" style="color: var(--color-accent-primary);">
            Hodnocení
          </h2>
          <VoteButtons
            client:load
            metaphorId={metaphor.id}
            initialLikes={metaphor.like_count}
            initialDislikes={metaphor.dislike_count}
            initialScore={metaphor.score}
          />
        </div>

        <!-- Author info if available -->
        {metaphor.autor_jmeno && (
          <div class="pt-8 text-sm sm:text-base" style="border-top: 1.5px solid var(--color-border); color: var(--color-text-secondary);">
            <p>
              Přidal(a): <span class="font-semibold" style="color: var(--color-text-primary);">{metaphor.autor_jmeno}</span>
            </p>
          </div>
        )}
      </div>
    </article>
  </div>
</BaseLayout>
