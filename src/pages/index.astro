---
export const prerender = true

import BaseLayout from '../layouts/BaseLayout.astro'
import SearchBar from '../components/SearchBar'
import { supabase } from '../lib/supabase'
import type { MetaphorWithVotes } from '../lib/types'

// Fetch published metaphors sorted by score (likes - dislikes)
const { data: metaphors, error } = await supabase
  .from('metaphors_with_votes')
  .select('*')
  .eq('status', 'published')
  .order('score', { ascending: false })
  .returns<MetaphorWithVotes[]>()

if (error) {
  console.error('Error fetching metaphors:', error)
}

// JSON-LD structured data for website
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Metafory.cz",
  "description": "Online datab치ze 캜esk칳ch metafor s mo쬹ost칤 vyhled치v치n칤, p콏id치v치n칤 a hodnocen칤.",
  "url": "https://metafory.cz",
  "inLanguage": "cs",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "https://metafory.cz/?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
---

<BaseLayout
  title="Metafory.cz - 캛esk칠 metafory a r캜en칤"
  description="Online datab치ze 캜esk칳ch metafor s mo쬹ost칤 vyhled치v치n칤, p콏id치v치n칤 a hodnocen칤. Objevte bohatstv칤 캜esk칠 콏e캜i."
>
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  <div>
    <div class="mb-12">
      <h1 class="text-3xl font-bold mb-3 text-gray-900">캛esk칠 metafory</h1>
      <p class="text-base text-gray-600 leading-relaxed">
        Objevte bohatstv칤 캜esk칠 콏e캜i. Proch치zejte, vyhled치vejte a p콏id치vejte vlastn칤 metafory.
      </p>
    </div>

    {metaphors && metaphors.length > 0 ? (
      <>
        {/* Nejobl칤ben캩j코칤 sekce */}
        {metaphors.length >= 3 && (
          <section class="mb-12">
            <h2 class="text-2xl font-bold mb-6 text-gray-900">Nejobl칤ben캩j코칤</h2>
            <div class="space-y-4">
              {metaphors.slice(0, 5).map((metaphor, index) => (
                <div class="flex gap-3 py-4 border-b border-gray-200 -mx-4 sm:-mx-6 px-4 sm:px-6">
                  <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-gray-900 text-white rounded-full font-bold text-sm">
                    {index + 1}
                  </div>
                  <div class="flex-grow">
                    <a href={`/metafora/${metaphor.slug}`} class="block hover:opacity-80 transition-opacity">
                      <h3 class="text-lg font-bold mb-1 text-gray-900">{metaphor.nazev}</h3>
                      <p class="text-sm text-gray-700 mb-2 leading-relaxed">{metaphor.definice}</p>
                      <div class="flex items-center gap-4 text-xs text-gray-500">
                        <span class="flex items-center gap-1">游녨 {metaphor.like_count}</span>
                        <span class="flex items-center gap-1">游녩 {metaphor.dislike_count}</span>
                        <span class="font-semibold">Sk칩re: {metaphor.score}</span>
                      </div>
                    </a>
                  </div>
                </div>
              ))}
            </div>
          </section>
        )}

        {/* V코echny metafory sekce */}
        <section>
          <h2 class="text-2xl font-bold mb-6 text-gray-900">V코echny metafory</h2>
          <SearchBar client:load metaphors={metaphors} />
        </section>
      </>
    ) : (
      <div class="text-center py-16 text-gray-500">
        <p class="mb-3">Zat칤m nejsou 쮂멳n칠 metafory.</p>
        <a href="/pridat" class="inline-block px-4 py-2 bg-gray-900 text-white rounded hover:bg-gray-700 transition-colors">
          P콏idejte prvn칤 metaforu
        </a>
      </div>
    )}
  </div>
</BaseLayout>
