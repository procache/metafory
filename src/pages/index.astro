---
export const prerender = false

import BaseLayout from '../layouts/BaseLayout.astro'
import SearchBar from '../components/SearchBar'
import { supabase } from '../lib/supabase'
import type { MetaphorWithVotes } from '../lib/types'

// Get search query from URL if present
const searchQuery = Astro.url.searchParams.get('q') || ''

// Fetch published metaphors sorted by score (likes - dislikes)
const { data: metaphors, error } = await supabase
  .from('metaphors_with_votes')
  .select('*')
  .eq('status', 'published')
  .order('score', { ascending: false })
  .returns<MetaphorWithVotes[]>()

if (error) {
  console.error('Error fetching metaphors:', error)
}

// JSON-LD structured data for website
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Metafory.cz",
  "description": "Online databáze českých metafor s možností vyhledávání, přidávání a hodnocení.",
  "url": "https://metafory.cz",
  "inLanguage": "cs",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "https://metafory.cz/?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
---

<BaseLayout
  title="Metafory.cz - České metafory a rčení"
  description="Online databáze českých metafor s možností vyhledávání, přidávání a hodnocení. Objevte bohatství české řeči."
>
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  <div>
    <div class="mb-14 sm:mb-16">
      <h1 class="font-bold mb-4 tracking-tight" style="color: var(--color-text-primary);">
        České metafory
      </h1>
      <p class="text-lg sm:text-xl leading-relaxed max-w-2xl" style="color: var(--color-text-secondary);">
        Objevte bohatství české řeči. Procházejte, vyhledávejte a přidávejte vlastní metafory.
      </p>
    </div>

    {metaphors && metaphors.length > 0 ? (
      <SearchBar client:load metaphors={metaphors} initialQuery={searchQuery} />
    ) : (
      <div class="text-center py-20 rounded-xl" style="background-color: var(--color-bg-card); border: 1.5px solid var(--color-border);">
        <p class="mb-5 text-lg" style="color: var(--color-text-secondary);">Zatím nejsou žádné metafory.</p>
        <a
          href="/pridat"
          class="inline-block px-6 py-3 rounded-lg font-medium hover:transform hover:scale-105 transition-all shadow-sm"
          style="background-color: var(--color-accent-primary); color: white;"
          onmouseover="this.style.backgroundColor='var(--color-accent-hover)'"
          onmouseout="this.style.backgroundColor='var(--color-accent-primary)'"
        >
          Přidejte první metaforu
        </a>
      </div>
    )}
  </div>
</BaseLayout>
